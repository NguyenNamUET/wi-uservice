from distutils.command.sdist import sdist
from distutils.errors import DistutilsExecError

from setuptools import setup, find_packages

class run_test_requests(sdist):
  def run(self):
    try:
      self.spawn(['pytest', 'src/tests/test_requests.py', '-v', '-s'])
    except DistutilsExecError:
      self.warn('Running test requests failed!')
    super().run()

class run_server_dev(sdist):
  def run(self):
    try:
      self.spawn(['gunicorn', '-c', 'dev.config.py', 'wsgi:application'])
    except DistutilsExecError:
      self.warn('Running test requests failed!')
    super().run()

class run_server_prod(sdist):
  def run(self):
    try:
      self.spawn(['gunicorn', '-c', 'prod.config.py', 'wsgi:application'])
    except DistutilsExecError:
      self.warn('Running test requests failed!')
    super().run()

NAME = {{#models}}{{#model}}"{{classname}}".lower(){{/model}}{{/models}}
VERSION = {{#apiVersion}}'{{apiVersion}}'{{/apiVersion}}{{^apiVersion}}'1.0.1'{{/apiVersion}}

REQUIRES = [
  "connexion==2.0.0",
  "swagger-ui-bundle==0.0.2"
]

setup(
  name=NAME,
  version=VERSION,
  author_email="info@i2g.cloud",
  url="https://github.com/tunghoang/wi-uservices",
  install_requires=REQUIRES,
  packages=find_packages(),
  package_data={'': ['src/specs/openapi.yaml']},
  include_package_data=True,
  cmdclass={
    'run_test_requests': run_test_requests,
    'run_server_dev': run_server_dev,
    'run_server_prod': run_server_prod
  }
)
