from distutils.command.sdist import sdist
from distutils.errors import DistutilsExecError

from setuptools import setup, find_packages

class RunTestRequests(sdist):
  def run(self):
    try:
      self.spawn(['pytest', 'src/tests/test_requests.py', '-v', '-s'])
    except DistutilsExecError:
      self.warn('Running test requests failed!')

class RunServerDev(sdist):
  def run(self):
    try:
      self.spawn(['gunicorn', '-c', 'dev.config.py', 'wsgi:application'])
    except DistutilsExecError:
      self.warn('Running development server failed!')

class RunServerProd(sdist):
  def run(self):
    try:
      self.spawn(['gunicorn', '-c', 'prod.config.py', 'wsgi:application'])
    except DistutilsExecError:
      self.warn('Running production server failed!')

NAME = {{#models}}{{#model}}"{{classFilename}}"{{/model}}{{/models}}
VERSION = {{#apiVersion}}'{{apiVersion}}'{{/apiVersion}}{{^apiVersion}}'1.0.1'{{/apiVersion}}

REQUIRES = [
  "connexion==2.0.0",
  "swagger-ui-bundle==0.0.2"
]

setup(
  name=NAME,
  version=VERSION,
  author_email="info@i2g.cloud",
  url="https://github.com/tunghoang/wi-uservices",
  install_requires=REQUIRES,
  packages=find_packages(),
  package_data={'': ['src/specs/openapi.yaml']},
  include_package_data=True,
  cmdclass={
    'run_test_requests': RunTestRequests,
    'run_server_dev': RunServerDev,
    'run_server_prod': RunServerProd
  }
)
